<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <script src="https://cdn.plot.ly/plotly-2.27.0.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&family=JetBrains+Mono:wght@400&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg-color: #0d1117;
            --panel-bg: #161b22;
            --border-color: #30363d;
            --text-primary: #c9d1d9;
            --text-secondary: #8b949e;
            --accent: #58a6ff;
            --success: #2ea043;
            --font-main: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            --font-mono: 'JetBrains Mono', monospace;
        }
        body { margin: 0; padding: 0; background-color: var(--bg-color); color: var(--text-primary); font-family: var(--font-main); overflow: hidden; display: flex; flex-direction: column; height: 100vh; }
        
        /* HEADER */
        .header {
            height: 60px;
            background-color: var(--panel-bg);
            border-bottom: 1px solid var(--border-color);
            display: flex;
            align-items: center;
            padding: 0 20px;
            justify-content: space-between;
        }
        .header-left { display: flex; align-items: center; gap: 15px; }
        .market-icon { width: 32px; height: 32px; background: var(--border-color); border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 16px; }
        .market-title { font-weight: 600; font-size: 16px; color: #fff; }
        .market-meta { display: flex; gap: 20px; font-size: 12px; color: var(--text-secondary); margin-left: 20px; }
        .meta-item { display: flex; flex-direction: column; }
        .meta-label { font-size: 10px; text-transform: uppercase; letter-spacing: 0.5px; }
        .meta-value { font-family: var(--font-mono); color: var(--text-primary); font-weight: 500; }
        
        /* ACTIONS */
        .actions { display: flex; gap: 10px; }
        .btn {
            background: transparent;
            border: 1px solid var(--border-color);
            color: var(--text-primary);
            padding: 6px 12px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 12px;
            font-weight: 500;
            display: flex;
            align-items: center;
            gap: 6px;
            transition: all 0.2s;
        }
        .btn:hover { background: var(--border-color); border-color: var(--text-secondary); }
        .btn.primary { background: var(--accent); color: #fff; border-color: var(--accent); }
        .btn.primary:hover { opacity: 0.9; }
        .star-btn { font-size: 16px; padding: 6px 10px; }
        .star-btn.active { color: #e3b341; border-color: #e3b341; background: rgba(227, 179, 65, 0.1); }

        /* CHART CONTAINER */
        #chart-container { flex: 1; position: relative; width: 100%; }
        #chart { width: 100%; height: 100%; }
        
    </style>
</head>
<body>
    <div class="header">
        <div class="header-left">
            <div class="market-icon">PM</div>
            <div>
                <div class="market-title" id="m-title">Loading...</div>
                <div style="font-size: 11px; color: var(--text-secondary);" id="m-desc"></div>
            </div>
            <div class="market-meta">
                <div class="meta-item">
                    <span class="meta-label">Volume (24h)</span>
                    <span class="meta-value" id="m-vol">--</span>
                </div>
                <div class="meta-item">
                    <span class="meta-label">Liquidity</span>
                    <span class="meta-value" id="m-liq">--</span>
                </div>
                <div class="meta-item">
                    <span class="meta-label">End Date</span>
                    <span class="meta-value" id="m-end">--</span>
                </div>
            </div>
        </div>
        <div class="actions">
            <button class="btn star-btn" id="star-btn" onclick="toggleStar()">☆</button>
            <button class="btn" onclick="downloadCSV()">
                <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"><polyline points="7 10 12 15 17 10"></polyline><line x1="12" y1="15" x2="12" y2="3"></line></svg>
                CSV
            </button>
            <button class="btn" onclick="downloadJSON()">JSON</button>
        </div>
    </div>
    
    <div id="chart-container">
        <div id="chart"></div>
    </div>

    <script>
        var injected_data = {{DATA}};

        function formatCurrency(val) {
            if (val >= 1000000) return "$" + (val/1000000).toFixed(1) + "M";
            if (val >= 1000) return "$" + (val/1000).toFixed(1) + "K";
            return "$" + val.toFixed(0);
        }

        function formatDate(isoStr) {
            if (!isoStr) return "--";
            return new Date(isoStr).toLocaleDateString(undefined, { month: 'short', day: 'numeric', year: 'numeric' });
        }

        // Initialize UI
        if (injected_data) {
            document.getElementById('m-title').innerText = injected_data.title || "Market";
            
            var meta = injected_data.metadata || {};
            if (meta.description) document.getElementById('m-desc').innerText = meta.description.substring(0, 60) + (meta.description.length > 60 ? "..." : "");
            
            document.getElementById('m-vol').innerText = formatCurrency(meta.volume_24h || 0);
            document.getElementById('m-liq').innerText = formatCurrency(meta.liquidity || 0);
            document.getElementById('m-end').innerText = formatDate(meta.end_date);
            
            if (meta.is_watched) {
                var btn = document.getElementById('star-btn');
                btn.classList.add('active');
                btn.innerText = "★";
            }
        }

        var layout = {
            plot_bgcolor: "#0d1117",
            paper_bgcolor: "#0d1117",
            font: { color: "#8b949e", family: "Inter, sans-serif", size: 11 },
            margin: { t: 40, r: 40, b: 40, l: 60 },
            xaxis: { 
                gridcolor: "#30363d", 
                zerolinecolor: "#30363d",
                linecolor: "#30363d",
                showspikes: true,
                spikethickness: 1,
                spikedash: "dot",
                spikecolor: "#58a6ff",
                rangeselector: {
                    buttons: [
                        {count: 1, label: '1D', step: 'day', stepmode: 'backward'},
                        {count: 7, label: '1W', step: 'day', stepmode: 'backward'},
                        {count: 1, label: '1M', step: 'month', stepmode: 'backward'},
                        {step: 'all', label: 'All'}
                    ],
                    bgcolor: '#161b22',
                    activecolor: '#30363d',
                    bordercolor: '#30363d',
                    borderwidth: 1,
                    font: {color: '#c9d1d9', size: 11},
                    x: 0,
                    y: 1.1
                }
            },
            yaxis: { 
                gridcolor: "#21262d", 
                zerolinecolor: "#30363d",
                showspikes: true,
                spikethickness: 1,
                spikedash: "dot",
                spikecolor: "#58a6ff",
                tickprefix: "$",
                autorange: true,
                fixedrange: false
            },
            hovermode: "x unified",
            dragmode: "pan",
            legend: {
                orientation: "h",
                yanchor: "bottom",
                y: 1.02,
                xanchor: "right",
                x: 1,
                font: { color: "#c9d1d9" }
            }
        };
        
        var config = {
            responsive: true,
            displayModeBar: false,
            scrollZoom: true,
            displaylogo: false
        };

        function render() {
            try {
                var data = injected_data;
                var traces = [];
                
                if (data.traces) {
                    data.traces.forEach(t => {
                        traces.push({
                            x: t.x,
                            y: t.y,
                            name: t.name,
                            type: 'scatter',
                            mode: 'lines',
                            line: { color: t.color, width: 2.5 },
                            hovertemplate: '%{y:.1%}<extra>%{fullData.name}</extra>' // Format as percentage if it's 0-1
                        });
                    });
                } else {
                    // Fallback
                }

                Plotly.newPlot('chart', traces, layout, config);
            } catch (e) {
                console.error(e);
            }
        }

        function toggleStar() {
            var btn = document.getElementById('star-btn');
            btn.classList.toggle('active');
            btn.innerText = btn.classList.contains('active') ? "★" : "☆";
            // Note: Visual only, doesn't sync back to CLI yet
        }

        function downloadJSON() {
            var dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(injected_data));
            var anchor = document.createElement('a');
            anchor.setAttribute("href", dataStr);
            anchor.setAttribute("download", "market_data.json");
            document.body.appendChild(anchor);
            anchor.click();
            anchor.remove();
        }

        function downloadCSV() {
            var csvContent = "data:text/csv;charset=utf-8,Date,Price\n";
            if (injected_data.traces && injected_data.traces.length > 0) {
                 var t = injected_data.traces[0];
                 for (var i=0; i < t.x.length; i++) {
                     csvContent += t.x[i] + "," + t.y[i] + "\n";
                 }
            }
            var anchor = document.createElement('a');
            anchor.setAttribute("href", csvContent);
            anchor.setAttribute("download", "market_data.csv");
            document.body.appendChild(anchor);
            anchor.click();
            anchor.remove();
        }

        render();
        window.onresize = function() { Plotly.Plots.resize('chart'); };
    </script>
</body>
</html>